<%= form_with(model: twitter) do |form| %>
  <% pxv = Artist.find_by_twtid_ignore_case(@twitter.twtid) %>
  <% if twitter.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(twitter.errors.count, "error") %> prohibited this twitter from being saved:</h2>

      <ul>
        <% twitter.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= link_to %!表示リフレッシュ!, twitter_path(@twitter, refresh: "y") if @twitter.twtid %>
  <% if pxv.presence %>
    PXV最終投稿日:<%= pxv.get_datetime_string(pxv.last_ul_datetime) %>
  <% end %>
  <% if @twitter.twtid %>
    <h3>TWTを開く→<%= link_to_ex %!@#{@twitter.twtid}!, Twt::twt_user_url(@twitter.twtid) %></h3>
  <% end %>
  <div>
    <%= form.label :twtid, style: "display: block" %>
    <% if params[:twtid].presence %>
      <% param_twtid = params[:twtid] %>
      @<%= form.text_field :twtid, value: param_twtid %>
      <h3>TWTを開く→<%= link_to_ex %!@#{param_twtid}!, Twt::twt_user_url(param_twtid) %></h3>
    <% else %>
      @<%= form.text_field :twtid %>
    <% end %>
    
  </div>

  <div>
    <% if twitter.twtname.presence %>
      <% twtname = twitter.twtname %>
    <% elsif params[:twtname].presence %>
      <% twtname = params[:twtname] %>
    <% else %>
      <% twtname = "" %>
    <% end %>

    <%= form.label :twtname, style: "display: block" %>
    <%= form.text_field :twtname, value: twtname %>
  </div>

  <div>
    <%= form.label :評価, style: "display: block" %>
    <%= form.select :rating,
      [
        ["100", "100"],
        ["95", "95"], 
        ["90", "90"], 
        ["85", "85"], 
        ["80", "80"], 
        ["75", "75"], 
        ["70", "70"], 
        ["65", "65"], 
        ["60", "60"], 
        ["55", "55"], 
        ["50", "50"], 
        ["45", "45"], 
        ["40", "40"], 
        ["35", "35"], 
        ["30", "30"], 
        ["25", "25"], 
        ["20", "20"], 
        ["15", "15"], 
        ["10", "10"], 
      ],
      include_blank: "選択して下さい" %>
  </div>

  <div>
    <%= form.label "更新頻度(100日間での投稿数)", style: "display: block" %>
    <%= form.number_field :update_frequency %>
  </div>

  <div>
    <% if twitter.status.presence %>
      <% status_value = twitter.status %>
    <% elsif params[:status].presence %>
      <% status_value = params[:status] %>
    <% else %>
      <% status_value = "" %>
    <% end %>
    <% puts %!#{status_value}/#{params[:status]}/#{twitter.status}!% %>

    <%= form.label :状態, style: "display: block" %>
    <%= form.select :status,
      [
        ["TWT巡回", "TWT巡回"],
        ["TWT巡回不要", "TWT巡回不要"],
        ["長期更新なし★", "長期更新なし"], 
        ["TWT巡回不要(PXVチェック)", "TWT巡回不要(PXVチェック)"],
        ["最近更新してない？", "最近更新してない？"], 
        ["アカウント削除", "削除"],
        ["存在しない", "存在しない"],
        ["凍結", "凍結"],
        ["非公開アカウント", "非公開アカウント"],
        ["別アカウントに移行（存在はするが更新していない？）", "別アカウントに移行"],
        ["アカウントID変更", "アカウントID変更"],
      ],
      { selected: status_value },
      include_blank: "選択して下さい" %>
    <input type="button" value="TWT巡回に変更" onclick="set_noupdate(0);" />
    <input type="button" value="長期更新なしに変更" onclick="set_noupdate(2);" />
    <script>
      function set_noupdate(idx) {
        let status_sel_box = document.getElementById("twitter_status");
        let options = status_sel_box.options;
        options[idx].selected = true;
      }
    </script>
  </div>

  <div>
    <%= form.label :描画方法, style: "display: block" %>
    <%= form.select :drawing_method,
      [
        ["手描き", "手描き"],
        ["AI", "AI"],
        ["3D", "3D"],
        ["パクリ（転載）", "パクリ"],
      ],
      include_blank: "選択して下さい" %>
    <input type="button" value="AI" onclick="set_draw_method(2);" />
    <input type="button" value="手描き" onclick="set_draw_method(1);" />
    <script>
      function set_draw_method(idx) {
        let status_sel_box = document.getElementById("twitter_drawing_method");
        let options = status_sel_box.options;
        options[idx].selected = true;
      }
    </script>
  </div>

  <div>
    <%= form.label :r18, style: "display: block" %>

    <%= form.radio_button :r18, :R18 %>
    <%= form.label :r18_r18, "R18" %>
    <br />

    <%= form.radio_button :r18, :R15 %>
    <%= form.label :r18_r15, "R15" %>
    <br />

    <%= form.radio_button :r18, :R12 %>
    <%= form.label :r18_r12, "R12" %>
    <br />

    <%= form.radio_button :r18, :全年齢 %>
    <%= form.label :r18_全年齢, "全年齢" %>
    <br />
  </div>

  <hr />
  
  <div>
    <%= form.submit("更新", class: 'subtmi-btn') %>
    <input type="button" value="DL日時を現在時刻に設定" onclick="set_time('twitter_last_dl_datetime');" />
  </div>

  <div>
    <%= form.label :pxvid, style: "display: block" %>
    <% if @twitter.pxvid.presence %>
      <%= link_to_ex "#{@twitter.pxvid}", Pxv::pxv_user_url(@twitter.pxvid) %>
      <br />
      <%= form.number_field :pxvid %>
    <% else %>
      <% if params[:pxvid].presence %>
        <%= form.number_field :pxvid, value: params[:pxvid] %>
      <% elsif pxv.presence %>
        <%= form.number_field :pxvid, value: pxv.pxvid %>
        <%= "new" %>
      <% else %>
        <%= form.number_field :pxvid %>
      <% end %>
    <% end %>

    <% if pxv.presence and twitter.pxvid == "" %>
      <%= %!pxvid="#{pxv.pxvid}"! %>
      【<%= pxv.rating %>】
      [A:<%= pxv.last_access_datetime_disp %>|DL:<%= pxv.last_dl_datetime_disp %>]|最新UL:<%= pxv.last_ul_datetime_disp %>]
      [※<%= pxv.status %>|<%= pxv.feature %>|<%= pxv.pxvname %>|<%= pxv.r18 %>]
      [<%= link_to_ex("show", artist_path(pxv.id, access_dt_update: "yes")) %>]
      予測：<%= pxv.prediction_up_cnt(true) %>
        <br />
        <%= pic_path_tag(twitter.pxvid, 5, '10%', true) %>
        <br />
    <% else %>
      <% pxv2 = Artist.find_by(pxvid: @twitter.pxvid) %>
      <% if pxv2.presence %>
        <br />
        【<%= pxv2.rating %>】<%= pxv2.r18 %>
        <br />
        <%= pxv2.pxvname %>(@<%= pxv2.twtid %>)
        [※<%= pxv2.status %>|<%= pxv2.feature %>|
        <br />
        [DL:<%= pxv2.last_dl_datetime_disp %>|最新UL:<%= pxv2.last_ul_datetime_disp %>]
        <br />
        [<%= link_to_ex("■pxv■", artist_path(pxv2.id, access_dt_update: "yes")) %>]
        予測：<%= pxv2.prediction_up_cnt(true) %>
        [A:<%= pxv2.last_access_datetime_disp %>]
        <br />
        <%= pxv2.filenum %>
        <br />
        <% if pxv2.filenum < 1000 %>
          <%= pic_path_tag(@twitter.pxvid, 5, '10%', true) %>
          <br />
        <% end %>
      <% else %>
        <% pxv3 = Artist.looks("pxvname", twtname, "partial_match") %>
        <% if pxv3.presence and @twitter.twtname.presence and @twitter.twtname.size > 2 %>
          <br />
          類似名あり：<br />
          <% pxv3.each do |pxv_n| %>
            【<%= pxv_n.pxvname %>(<%= pxv_n.pxvid %>)|@<%= pxv_n.twtid %>】|<%= pxv_n.feature %>
            <%= link_to_ex("■pxv■", artist_path(pxv_n.id, access_dt_update: "yes")) %>
            <br />
          <% end %>
        <% elsif twitter.pxvid %>
          <br />
          <% dirlist = Pxv::stock_dir_list %>
          <% user_name = Pxv::user_name(dirlist, twitter.pxvid) %>
          <%= user_name %>(未登録)
        <% end %>
      <% end %>
    <% end %>
  </div>

  <hr />

  <div>
    <%= form.label :コメント, style: "display: block" %>
    <%= form.text_field :comment %>
  </div>

  <div>
    <%= form.label :備考, style: "display: block" %>
    <%= form.text_field :remarks %>
  </div>

  <div>
    <%= form.label :別ID, style: "display: block" %>
    @<%= form.text_field :alt_twtid %>
    <%=  %>
    <%= link_to_ex "@#{@twitter.alt_twtid}", Twt::twt_user_url(@twitter.alt_twtid) if @twitter.alt_twtid.presence %>
    <% alt_twt = Twitter.find_by_twtid_ignore_case(@twitter.alt_twtid) %>
    <% if alt_twt.presence %>
      <%= alt_twt.twtname %>
      【<%= alt_twt.rating %>|<%= alt_twt.drawing_method %>|<%= alt_twt.status %>】
      [<%= link_to_ex "■twt■", alt_twt %>]
      |<%= alt_twt.last_access_datetime_disp %>|
      <%= %!|PXVID:#{alt_twt.pxvid}! if alt_twt.pxvid.presence %>
    <% end %>
  </div>

  <div>
    <%= form.label :旧ID, style: "display: block" %>
    @<%= form.text_field :old_twtid %>
    <%= link_to_ex "@#{@twitter.old_twtid}", Twt::twt_user_url(@twitter.old_twtid) if @twitter.old_twtid.presence %>
    <% old_twt = Twitter.find_by_twtid_ignore_case(@twitter.old_twtid) %>
    <% if old_twt.presence %>
      <%= old_twt.twtname %>
      【<%= old_twt.rating %>|<%= old_twt.status %>】
      [<%= link_to_ex "■twt■", old_twt %>]
      |<%= old_twt.last_access_datetime_disp %>|
    <% end %>
  </div>

  <div>
    <%= form.label :警告, style: "display: block" %>
    <%= form.select :warning,
      [
        ["パクリ", "パクリ"],
      ],
      include_blank: "選択して下さい" %>
  </div>

  <hr />
  
  <div>
    <%= form.label :総ファイル数, style: "display: block" %>
    現在の設定値：<%= @twitter.filenum %>↓<br />
    
    <% if @twt_pic_path_list %>
      <%= form.number_field :filenum, value: @twt_pic_path_list.size %>
    <% else %>
      <%= form.number_field :filenum %>
    <% end %>
  </div>

  <div>
    <%= form.label :最近のファイル数, style: "display: block" %>
    <%= form.number_field :recent_filenum %>
  </div>

  <div>
    <%= form.label :最新DL日時, style: "display: block" %>
    <%= form.datetime_field :last_dl_datetime %>
  </div>

  <div>
    <%= form.label :最新投稿日時, style: "display: block" %>
    <% if @twt_pic_path_list %>
      <% twt_pic_list = @twt_pic_path_list.map {|x| [Twt::twt_path_str(x), x]}.sort.reverse %>
    <% else %>
      <% twt_pic_list = nil %>
    <% end %>
    <% if twt_pic_list and twt_pic_list[0] != nil %>
      <% ul_date = Twt::get_time_from_path(twt_pic_list[0][1]) %>
      <%= @twitter.last_post_datetime %>↓<br />
      <%= form.datetime_field :last_post_datetime, value: ul_date.strftime("%Y-%m-%d %H:%M:%S") %>
    <% else %>
      <%= form.datetime_field :last_post_datetime %>
    <% end %>
  </div>

  <div>
    <%= form.label :最新アクセス日時, style: "display: block" %>
    <%= form.datetime_field :last_access_datetime %>
  </div>
<% end %>

<script>
  function set_time(elem_id) {
    let elem = document.getElementById(elem_id);
    let date = new Date(elem.value);

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    now.setSeconds(date.getSeconds());//よくわからないが秒の値を変更前と合わせないとブラウザでエラーになる
    
    let isostr = now.toISOString();
    //2024-01-31T13:54:35.371Z
    //                   54321
    let val = isostr.slice(0, -5);
    //let val = isostr.slice(0, -8);
    elem.value = val;
  }
</script>
